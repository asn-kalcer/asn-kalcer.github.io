<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Data Viewer</title>
  
  <!-- ==== (1) CSS Aplikasi Asli (dipertahankan) ==== -->
  <style>
    :root{
      --bg:#f8fafc; /* slate-50 */
      --card:#ffffff;
      --ink:#0f172a; /* slate-900 */
      --muted:#475569; /* slate-600 */
      --soft:#94a3b8; /* slate-400 */
      --border:#e2e8f0; /* slate-200 */
      --accent:#2563eb; /* blue-600 */
      --accent-2:#dbeafe; /* blue-100 */
      --chip:#eef2ff; /* indigo-50 */
      --chip-ink:#3730a3; /* indigo-800 */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Noto Sans",sans-serif}
    .container{max-width:980px;margin:0 auto;padding:24px}

    header{position:sticky;top:0;background:linear-gradient(180deg,#ffffffee,#ffffffdd 65%,#ffffff00);backdrop-filter:saturate(1.2) blur(6px);z-index:5;border-bottom:1px solid var(--border)}
    header .bar{display:flex;gap:12px;align-items:center;max-width:980px;margin:0 auto;padding:12px 24px}
    .logo{font-weight:800;letter-spacing:0.2px}
    .logo .x{font-size:18px;display:inline-block;transform:translateY(-1px)}

    .panel{display:grid;grid-template-columns:1fr;gap:12px;margin:16px 0}
    .controls{display:flex;flex-wrap:wrap;gap:8px}
    .controls > *{border:1px solid var(--border);background:#fff;color:var(--ink);padding:10px 12px;border-radius:12px}
    .controls input[type="text"]{min-width:220px;flex:1}
    .controls select{min-width:180px}
    .controls .file{padding:8px 10px}
    .hint{font-size:12px;color:var(--muted)}

    .stream{display:grid;gap:12px}

    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px 16px;display:grid;grid-template-columns:auto 1fr;gap:12px}
    .avatar{width:44px;height:44px;border-radius:999px;background:var(--accent-2);border:1px solid var(--border);display:grid;place-items:center;font-weight:700;color:var(--accent)}
    .meta{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .name{font-weight:700}
    .handle,.time{color:var(--muted)}
    .badge{font-size:12px;background:var(--chip);color:var(--chip-ink);border:1px solid #e0e7ff;padding:2px 8px;border-radius:999px}
    .text{white-space:pre-wrap}
    .chips{display:flex;gap:6px;flex-wrap:wrap;margin:6px 0}
    .chip{font-size:12px;background:#f1f5f9;border:1px solid var(--border);color:#0f172a;padding:2px 8px;border-radius:999px}

    .stats{display:flex;gap:18px;color:var(--muted);font-size:14px;align-items:center}
    .stat{display:inline-flex;gap:6px;align-items:center}
    .stat b{color:var(--ink);font-weight:700}
    .stat a{color:inherit;text-decoration:none;display:inline-flex;align-items:center;gap:6px}
    .stat a:hover{text-decoration:underline}

    .toolbar{display:flex;align-items:center;justify-content:space-between;margin:8px 0}
    .count{color:var(--muted)}

    .hr{height:1px;background:var(--border);margin:8px 0}

    .empty{padding:32px;border:1px dashed var(--border);border-radius:16px;background:#fff;color:var(--muted);text-align:center}

    .footer-controls{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-top:8px}
    .pagination{display:flex;gap:6px}
    .pagination button{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer}
    .pagination button[disabled]{opacity:.5;cursor:not-allowed}

    details.inline{display:inline}
    details.inline summary{cursor:pointer;display:inline;color:var(--accent)}

    /* ===== Modal styles (shared) */
    .backdrop{position:fixed;inset:0;background:rgba(15,23,42,.35);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{width:min(920px,calc(100% - 32px));max-height:82vh;overflow:auto;background:#fff;border:1px solid var(--border);border-radius:16px;padding:16px}
    .modal h3{margin:0 0 8px 0}
    .modal .muted{color:var(--muted);font-size:12px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .divider{height:1px;background:var(--border);margin:10px 0}

    /* Advanced Search */
    .cond-row{display:grid;grid-template-columns:minmax(160px,1fr) 2fr auto;gap:8px;align-items:center;margin-bottom:8px}
    .modal .btn{padding:8px 10px;border-radius:10px}
    .dates input[type="date"], .modal select, .modal input[type="text"], textarea{padding:8px 10px;border-radius:10px;border:1px solid var(--border)}
    textarea{width:100%;min-height:160px}
  </style>

  <!-- ==== (2) CSS App Shell (diletakkan SETELAH CSS asli) ==== -->
  <style>
    :root{
      --sb-bg:#ffffff; --sb-border:#e2e8f0; --sb-ink:#0f172a; --sb-muted:#64748b;
      --sb-accent:#2563eb; --sb-accent-ink:#ffffff; --sb-shadow:0 1px 2px rgba(15,23,42,.06);
    }
    /* ===== App Shell ===== */
    .app-shell{display:grid;grid-template-columns:280px 1fr;min-height:100dvh;background:#f8fafc;color:var(--sb-ink)}
    .app-shell.collapsed{grid-template-columns:100px 1fr}
    .app-sidebar{position:sticky;top:0;height:100dvh;padding:12px}
    .sb-card{height:100%;background:var(--sb-bg);border:1px solid var(--sb-border);border-radius:16px;box-shadow:var(--sb-shadow);display:flex;flex-direction:column}
    .sb-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--sb-border)}
    .sb-brand{display:flex;align-items:center;gap:10px}
    .sb-logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,#60a5fa,#34d399)}
    .sb-title{font-weight:800}
    .sb-toggle{cursor:pointer;border:1px solid var(--sb-border);background:#fff;border-radius:10px;padding:8px}
    .sb-nav{padding:12px;display:grid;gap:8px;overflow:auto}
    .sb-link{display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px solid var(--sb-border);border-radius:12px;background:#fff;color:var(--sb-ink);text-decoration:none;font-weight:600}
    .sb-link:hover{border-color:#cbd5e1}
    .sb-link.active{background:var(--sb-accent);border-color:transparent;color:var(--sb-accent-ink)}
    .sb-ico{width:22px;height:22px;display:inline-grid;place-items:center}
    .sb-ico svg{width:20px;height:20px}
    .sb-label{white-space:nowrap}
    .sb-help{margin-top:auto;padding:12px;border-top:1px dashed var(--sb-border);font-size:13px;color:var(--sb-muted)}
    /* Collapsed: sembunyikan label, center ikon */
    .app-shell.collapsed .sb-title,.app-shell.collapsed .sb-label,.app-shell.collapsed .sb-help{display:none}
    .app-shell.collapsed .sb-head{justify-content:center}
    .app-main{padding:20px}
    /* Optional: konten kartu di halaman */
    .app-card{background:#fff;border:1px solid var(--sb-border);border-radius:16px;box-shadow:var(--sb-shadow);padding:16px}
  </style>
</head>
<body>
  <!--
  PROMPT / INSTRUKSI PENERAPAN
  1) Kode app shell ditempel di awal <body>, lalu konten halaman dipindah ke <main class="app-main">.
  2) Ganti href tombol layanan sesuai file Anda. Di bawah sudah ditambah item "Data Viewer" untuk halaman ini.
  3) Auto-detect link aktif berdasarkan window.location.pathname; bisa juga manual menambahkan class="active".
  4) Sidebar bisa collapse/expand, state disimpan pada localStorage ('sb-collapsed').
  5) CSS shell ter-namespaced agar minim bentrok dengan CSS aplikasi.
  -->

  <div id="APP" class="app-shell">
    <!-- ===== SIDEBAR ===== -->
    <aside class="app-sidebar" aria-label="Navigasi Layanan">
      <div class="sb-card">
        <div class="sb-head">
          <div class="sb-brand">
            <div class="sb-title">TVRI on <span class="x">ùïè</span></div>
          </div>
          <button id="sbToggle" class="sb-toggle" title="Sembunyikan/Expand sidebar" aria-expanded="true">‚ü®‚ü©</button>
        </div>
         <nav class="sb-nav">
          <a class="sb-link" href="data_viewer.html" title="Data Viewer"><span class="sb-ico">{#icon-doc#}</span><span class="sb-label">Data Viewer</span></a>
          <a class="sb-link" href="distribusi_nilai.html" title="Distribusi Nilai"><span class="sb-ico">{#icon-chart#}</span><span class="sb-label">Distribusi Nilai</span></a>
          <a class="sb-link" href="persilangan_nilai.html" title="Persilangan Nilai"><span class="sb-ico">{#icon-grid#}</span><span class="sb-label">Persilangan Nilai</span></a>
          <a class="sb-link" href="timeline_distribusi.html" title="Analisis Timeline"><span class="sb-ico">{#icon-trend#}</span><span class="sb-label">Analisis Timeline</span></a>
          <a class="sb-link active" href="analisis_interaksi.html" title="Analisis Interaksi"><span class="sb-ico">{#icon-trend#}</span><span class="sb-label">Analisis Interaksi</span></a>
         <!--  <a class="sb-link" href="laporan-ringkas.html" title="Laporan Ringkas"><span class="sb-ico">{#icon-doc#}</span><span class="sb-label">Laporan Ringkas</span></a>
          <a class="sb-link" href="pengaturan.html" title="Pengaturan"><span class="sb-ico">{#icon-cog#}</span><span class="sb-label">Pengaturan</span></a> -->
      </nav>
      </div>
    </aside>

    <!-- ===== KONTEN HALAMAN (aplikasi asli dipindah ke sini) ===== -->
    <main class="app-main">
      <!-- ======== HEADER APLIKASI ASLI ======== -->
      <header>
        <div class="bar">
          <div class="logo">Data Viewer</div>
        </div>
      </header>

      <!-- ======== KONTEN APLIKASI ASLI ======== -->
      <div class="container">
        <section class="panel">
          <div class="controls">
            <input id="file" class="file" type="file" accept=".csv" />
            <select id="colSelect" disabled>
              <option value="__all__">Cari di semua kolom</option>
            </select>
            <input id="query" type="text" placeholder="Ketik kata kunci‚Ä¶ (abaikan huruf besar/kecil)" disabled />
            <button id="btnSearch" class="btn" disabled>üîé Cari</button>
            <button id="btnClear" class="btn" disabled>‚úñÔ∏è Bersihkan</button>
            <button id="btnAdvanced" class="btn" disabled>üß≠ Advanced Search</button>
            <button id="btnExportAlasan" class="btn" disabled>üìã Ekspor Intisari</button>
          </div>
        </section>

        <div class="toolbar">
          <div class="count" id="countInfo">Belum ada data.</div>
        </div>
        <div class="hr"></div>

        <section id="stream" class="stream">
          <div class="empty">Unggah file CSV terlebih dahulu. Baris akan ditampilkan seperti kartu cuitan. üéØ</div>
        </section>

        <div class="footer-controls">
          <div class="pagination">
            <button id="prev">‚Üê Sebelumnya</button>
            <button id="next">Berikutnya ‚Üí</button>
          </div>
          <div class="hint">Menampilkan <span id="pageInfo">0/0</span> ‚Ä¢ Maks 25 kartu per halaman</div>
        </div>
      </div>

      <!-- ===== Modal Advanced Search -->
      <div id="advBackdrop" class="backdrop" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="advTitle">
          <h3 id="advTitle">Advanced Search</h3>
          <div class="muted">Semua pencarian <b>case-insensitive</b> & mengabaikan spasi berlebih. Kondisi digabungkan dengan <b>AND</b>.</div>

          <div id="condList"></div>
          <div class="row"><button id="btnAddCond" class="btn">Ôºã Tambah kondisi</button></div>

          <div class="divider"></div>
          <div id="dateBlock">
            <div class="row">
              <div><b>Rentang waktu</b> (berdasarkan kolom <code>created_at</code>)</div>
              <div class="muted" id="dateStatus"></div>
            </div>
            <div class="row dates">
              <input type="date" id="dateFrom" />
              <span class="muted">s.d.</span>
              <input type="date" id="dateTo" />
            </div>
          </div>

          <div class="divider"></div>
          <div class="row" style="justify-content: flex-end;">
            <button id="btnApplyAdv" class="btn">Terapkan</button>
            <button id="btnClearAdv" class="btn">Bersihkan</button>
            <button id="btnCloseAdv" class="btn">Tutup</button>
          </div>
        </div>
      </div>

      <!-- ===== Modal Ekspor Alasan -->
      <div id="alasanBackdrop" class="backdrop" aria-hidden="true">
        <div class="modal" role="dialog" aria-modal="true" aria-labelledby="alasanTitle">
          <h3 id="alasanTitle">Gabungan Intisari (berdasarkan hasil saat ini)</h3>
          <div class="muted" id="alasanStatus">‚Äî</div>
          <div class="divider"></div>
          <textarea id="alasanText" placeholder="Hasil akan muncul di sini‚Ä¶" readonly></textarea>
          <div class="divider"></div>
          <div class="row" style="justify-content:flex-end">
            <button id="btnCopyAlasan" class="btn">üìé Salin</button>
            <button id="btnDownloadAlasan" class="btn">‚¨áÔ∏è Unduh .txt</button>
            <button id="btnCloseAlasan" class="btn">Tutup</button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- ====== Ikon SVG & Script App Shell ====== -->
  <script>
    const ICONS = {
      chart:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><rect x="7" y="10" width="3" height="7" rx="1"/><rect x="12" y="6" width="3" height="11" rx="1"/><rect x="17" y="12" width="3" height="5" rx="1"/></svg>`,
      grid:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 3v18"/></svg>`,
      trend:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M3 17l6-6 4 4 7-7"/><path d="M21 21H3"/></svg>`,
      cloud:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M17.5 19a4.5 4.5 0 0 0 .5-9 6 6 0 0 0-11.3-1.8A4 4 0 0 0 7 19h10.5z"/></svg>`,
      doc:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M8 13h8M8 17h6M8 9h3"/></svg>`,
      cog:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33h0A1.65 1.65 0 0 0 9 3.09V3a2 2 0 1 1 4 0v.09c0 .66.39 1.25 1 1.51h0a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06c-.47.47-.61 1.17-.33 1.78.24.52.73.86 1.29.86H21a2 2 0 1 1 0 4h-.09c-.66 0-1.25.39-1.51 1z"/></svg>`
    };

    // Ganti placeholder {#icon-...#} dengan SVG
    document.querySelectorAll('.sb-ico').forEach(el=>{
      const html = el.innerHTML;
      const key = /\{#icon-([a-z]+)#\}/.exec(html);
      if(key && ICONS[key[1]]) el.innerHTML = ICONS[key[1]]; else el.innerHTML = ICONS.chart;
    });

    // Collapse toggle + persistence
    const APP = document.getElementById('APP');
    const SB_TOGGLE = document.getElementById('sbToggle');
    function applySBState(){
      const collapsed = localStorage.getItem('sb-collapsed') === '1';
      APP.classList.toggle('collapsed', collapsed);
      SB_TOGGLE.setAttribute('aria-expanded', collapsed ? 'false' : 'true');
    }
    SB_TOGGLE.addEventListener('click',()=>{
      const next = !(localStorage.getItem('sb-collapsed') === '1');
      localStorage.setItem('sb-collapsed', next ? '1' : '0');
      applySBState();
    });
    applySBState();

    // Auto-aktifkan link berdasarkan URL (fallback jika class="active" tidak diset manual)
    (function autoActive(){
      const path = location.pathname.split('/').pop();
      let matched = false;
      document.querySelectorAll('.sb-link').forEach(a=>{
        const href = a.getAttribute('href');
        if(!href) return;
        const fname = href.split('/').pop();
        if(fname && fname === path){ a.classList.add('active'); matched = true; }
      });
      // Jika tak ada yang match, biarkan yang sudah diberi class active oleh developer
    })();
  </script>

  <!-- ====== Script Aplikasi Asli (dipertahankan) ====== -->
  <script>
    const byId = (id)=>document.getElementById(id);
    const fileInput = byId('file');
    const colSelect = byId('colSelect');
    const queryInput = byId('query');
    const btnSearch = byId('btnSearch');
    const btnClear = byId('btnClear');
    const btnAdvanced = byId('btnAdvanced');
    const btnExportAlasan = byId('btnExportAlasan');
    const stream = byId('stream');
    const countInfo = byId('countInfo');
    const prevBtn = byId('prev');
    const nextBtn = byId('next');
    const pageInfo = byId('pageInfo');

    // Advanced Search elements
    const advBackdrop = byId('advBackdrop');
    const condList = byId('condList');
    const btnAddCond = byId('btnAddCond');
    const btnApplyAdv = byId('btnApplyAdv');
    const btnClearAdv = byId('btnClearAdv');
    const btnCloseAdv = byId('btnCloseAdv');
    const dateFromEl = byId('dateFrom');
    const dateToEl = byId('dateTo');
    const dateStatus = byId('dateStatus');

    // Alasan export elements
    const alasanBackdrop = byId('alasanBackdrop');
    const alasanText = byId('alasanText');
    const alasanStatus = byId('alasanStatus');
    const btnCopyAlasan = byId('btnCopyAlasan');
    const btnDownloadAlasan = byId('btnDownloadAlasan');
    const btnCloseAlasan = byId('btnCloseAlasan');

    let DATA = [];
    let FILTERED = [];
    let HEADERS = [];
    const PAGE_SIZE = 25;
    let page = 1;

    // CSV parser (quote-aware)
    function parseCSV(text){
      const rows = []; let row = []; let cur = ''; let inQuotes = false;
      for(let i=0;i<text.length;i++){
        const ch = text[i]; const next = text[i+1];
        if(inQuotes){
          if(ch==='"' && next==='"'){ cur+='"'; i++; }
          else if(ch==='"'){ inQuotes=false; }
          else { cur+=ch; }
        } else {
          if(ch==='"'){ inQuotes=true; }
          else if(ch===','){ row.push(cur); cur=''; }
          else if(ch==='\n'){ row.push(cur); rows.push(row); row=[]; cur=''; }
          else if(ch==='\r'){ }
          else { cur+=ch; }
        }
      }
      if(cur.length>0 || row.length>0){ row.push(cur); rows.push(row); }
      return rows;
    }

    const norm = (s)=> String(s==null? '': s).replace(/\s+/g,' ').trim().toLowerCase();
    const isEmpty = (s)=> norm(s)==='';

    function inferCols(header){
      const h = header.map(x=>x.toLowerCase());
      const find = (...keys)=>{ for(const k of keys){ const idx = h.indexOf(k); if(idx!==-1) return header[idx]; } return null; };
      const user_screen_name = find('user_screen_name');
      return {
        text: find('text','tweet','full_text','content'),
        user: user_screen_name || find('user','username','author','name'),
        handle: user_screen_name,
        time: find('created_at','timestamp','time','date','datetime'),
        sentiment: find('sentimen','sentiment'),
        emotion: find('emosi','emotion','mood'),
        replies: find('replies','reply_count'),
        retweets: find('retweets','retweet_count','reposts','repost_count'),
        likes: find('likes','like_count','favorites','favorite_count','favourite_count'),
        url: find('url','link','status_url'),
        parent_text: find('parent_tweet_text'),
        alasan: find('alasan'),
        tweet_id: find('tweet_id','id','status_id')
      };
    }

    function emojiForSentiment(v){
      const s = norm(v);
      if(/positif|positive|pos/.test(s)) return 'üòä';
      if(/netral|neutral/.test(s)) return 'üòê';
      if(/negatif|negative|neg/.test(s)) return 'üò†';
      return 'üí¨';
    }
    function emojiForEmotion(v){
      const s = norm(v);
      if(/bahagia|senang|gembira|happy|joy/.test(s)) return 'üòÄ';
      if(/sedih|sad/.test(s)) return 'üò¢';
      if(/marah|anger|angry/.test(s)) return 'üò°';
      if(/takut|fear/.test(s)) return 'üò®';
      if(/terkejut|kaget|surprise/.test(s)) return 'üò≤';
      if(/jijik|disgust/.test(s)) return 'ü§¢';
      if(/percaya|trust/.test(s)) return 'ü§ù';
      if(/antisipasi|anticipation/.test(s)) return '‚è≥';
      return 'üé≠';
    }

    function initials(name){
      if(!name) return '?';
      const parts = String(name).trim().split(/\s+|_/);
      return (parts[0][0]||'').toUpperCase() + ((parts[1]||'')[0]||'').toUpperCase();
    }

    // Format tanggal tampilan dd-mm-yyyy (untuk header)
    function formatDMY(val){
      const d = parseDate(val); if(!d) return String(val||'');
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yy = d.getFullYear();
      return `${dd}-${mm}-${yy}`;
    }
    // Parse berbagai format tanggal menjadi Date (atau null)
    function parseDate(val){
      if(!val) return null; const raw = String(val).trim();
      let d = null;
      if(/^\d{4}-\d{2}-\d{2}/.test(raw)) d = new Date(raw);
      else if(/^\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}$/.test(raw)){
        const p = raw.split(/[\/\-]/).map(Number); let dd=p[0], mm=p[1]-1, yy=p[2]; if(yy<100) yy+=2000; d = new Date(yy,mm,dd);
      } else {
        const t = Date.parse(raw); if(!Number.isNaN(t)) d = new Date(t);
      }
      if(!d || Number.isNaN(d.getTime())) return null; return d;
    }

    function escapeHtml(s){
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }
    function escapeAttr(s){ return String(s).replace(/"/g,'&quot;'); }

    function decorateText(s){
      s = s.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noreferrer">$1</a>');
      s = s.replace(/(^|\s)#([\w_]+)/g, '$1<a href="https://x.com/hashtag/$2" target="_blank" rel="noreferrer">#$2</a>');
      s = s.replace(/(^|\s)@([\w_]+)/g, '$1<a href="https://x.com/$2" target="_blank" rel="noreferrer">@$2</a>');
      return s;
    }

    function buildRowObj(header, arr){ const o = {}; for(let i=0;i<header.length;i++) o[header[i]] = arr[i] ?? ''; return o; }

    function enableControls(){ colSelect.disabled = false; queryInput.disabled = false; btnSearch.disabled = false; btnClear.disabled = false; btnAdvanced.disabled = false; btnExportAlasan.disabled = false; }

    function populateColumnSelect(header){
      colSelect.innerHTML = '<option value="__all__">Cari di semua kolom</option>' + header.map(h=> `<option>${escapeHtml(h)}</option>`).join('');
    }

    function updateCounts(){
      const total = DATA.length, n = FILTERED.length; const maxPage = Math.max(1, Math.ceil(n / PAGE_SIZE));
      page = Math.min(page, maxPage);
      countInfo.textContent = `${n.toLocaleString('id-ID')} dari ${total.toLocaleString('id-ID')} baris`;
      pageInfo.textContent = `${page}/${maxPage}`;
      prevBtn.disabled = page<=1; nextBtn.disabled = page>=maxPage;
    }

    function renderPage(){
      stream.innerHTML = '';
      if(FILTERED.length===0){ stream.innerHTML = '<div class="empty">Tidak ada hasil untuk filter saat ini.</div>'; updateCounts(); return; }
      const start = (page-1)*PAGE_SIZE; const end = Math.min(start+PAGE_SIZE, FILTERED.length);
      const cols = inferCols(Object.keys(DATA[0]||{}));
      let html = '';
      for(let i=start;i<end;i++) html += renderCard(FILTERED[i], cols);
      stream.innerHTML = html; updateCounts();
    }

    function applyFilter(){
      const mode = colSelect.value; const q = norm(queryInput.value);
      if(isEmpty(q)) FILTERED = DATA.slice();
      else if(mode==='__all__') FILTERED = DATA.filter(row => Object.values(row).some(v => norm(v).includes(q)));
      else FILTERED = DATA.filter(row => norm(row[mode]).includes(q));
      page = 1; renderPage();
    }

    // ======= Advanced Search =======
    function openAdvanced(){ advBackdrop.style.display='flex'; advBackdrop.setAttribute('aria-hidden','false'); if(condList.children.length===0) addCondRow(); updateDateStatus(); }
    function closeAdvanced(){ advBackdrop.style.display='none'; advBackdrop.setAttribute('aria-hidden','true'); }

    function addCondRow(col='__all__', val=''){
      const wrap = document.createElement('div'); wrap.className='cond-row';
      const sel = document.createElement('select'); sel.className='cond-col';
      sel.innerHTML = `<option value="__all__">Semua kolom</option>` + HEADERS.map(h=> `<option value="${escapeAttr(h)}">${escapeHtml(h)}</option>`).join('');
      sel.value = col;
      const inp = document.createElement('input'); inp.className='cond-val'; inp.type='text'; inp.placeholder='Nilai yang dicari‚Ä¶'; inp.value = val;
      const del = document.createElement('button'); del.type='button'; del.className='btn'; del.textContent='üóëÔ∏è Hapus';
      del.addEventListener('click', ()=>{ condList.removeChild(wrap); });
      wrap.appendChild(sel); wrap.appendChild(inp); wrap.appendChild(del);
      condList.appendChild(wrap);
    }

    function getAdvConditions(){
      const rows = Array.from(condList.querySelectorAll('.cond-row'));
      const conds = [];
      for(const r of rows){
        const col = r.querySelector('.cond-col').value;
        const val = r.querySelector('.cond-val').value;
        if(!isEmpty(val)) conds.push({col, q: norm(val)});
      }
      return conds;
    }

    function rowMatchesAll(row, conds){
      return conds.every(({col,q})=>{
        if(col==='__all__') return Object.values(row).some(v => norm(v).includes(q));
        return norm(row[col]).includes(q);
      });
    }

    function applyAdvanced(){
      const conds = getAdvConditions();
      const cols = inferCols(HEADERS);
      const hasTime = !!cols.time;
      const fromStr = dateFromEl.value; const toStr = dateToEl.value;
      const from = fromStr? new Date(fromStr+'T00:00:00') : null;
      const to = toStr? new Date(toStr+'T23:59:59') : null;

      FILTERED = DATA.filter(row=>{
        if(conds.length && !rowMatchesAll(row, conds)) return false;
        if(hasTime && (from || to)){
          const d = parseDate(row[cols.time]); if(!d) return false;
          if(from && d < from) return false;
          if(to && d > to) return false;
        }
        return true;
      });
      page = 1; renderPage(); closeAdvanced();
    }

    function clearAdvanced(){
      condList.innerHTML=''; addCondRow(); dateFromEl.value=''; dateToEl.value='';
    }

    function updateDateStatus(){
      const cols = inferCols(HEADERS);
      if(cols.time) dateStatus.textContent = `Kolom waktu terdeteksi: "${cols.time}"`;
      else dateStatus.textContent = 'Kolom waktu (created_at) tidak ditemukan di header.';
    }

    // ======= Alasan export =======
    function openAlasan(){
      const cols = inferCols(HEADERS);
      if(!cols.alasan){ alert('Kolom "alasan" tidak ditemukan di CSV.'); return; }
      const list = FILTERED.map(r => String(r[cols.alasan]||'').trim()).filter(Boolean);
      alasanText.value = list.join(';');
      alasanStatus.textContent = `${list.length.toLocaleString('id-ID')} alasan dari ${FILTERED.length.toLocaleString('id-ID')} baris hasil.`;
      alasanBackdrop.style.display='flex'; alasanBackdrop.setAttribute('aria-hidden','false');
    }
    function closeAlasan(){ alasanBackdrop.style.display='none'; alasanBackdrop.setAttribute('aria-hidden','true'); }
    async function copyAlasan(){
      try{ await navigator.clipboard.writeText(alasanText.value); btnCopyAlasan.textContent='‚úÖ Disalin'; setTimeout(()=>btnCopyAlasan.textContent='üìé Salin', 1200); }
      catch{ alert('Gagal menyalin ke clipboard.'); }
    }
    function downloadAlasan(){
      const blob = new Blob([alasanText.value], {type:'text/plain;charset=utf-8'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'alasan.txt';
      document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href), 3000);
    }

    // ===== Render card & actions =====
    function renderCard(row, cols){
      const screen = row[cols.user] || 'pengguna';
      const user = screen; const handle = screen ? '@'+screen : '';
      const txt = row[cols.text] ?? '';
      const timeRaw = row[cols.time] ?? ''; const time = timeRaw ? formatDMY(timeRaw) : '';
      const sent = row[cols.sentiment]; const emo = row[cols.emotion];
      const replies = row[cols.replies]; const retweets = row[cols.retweets]; const likes = row[cols.likes];
      const url = row[cols.url]; const parent = row[cols.parent_text]; const alasan = row[cols.alasan];
      const tid = row[cols.tweet_id];

      const exclude = new Set([
        'kind','user_id','tweet_id','parent_tweet_id','in_reply_to_id',
        'retweet_count','user_screen_name','relevan','favourite_count','favorite_count','sentimen','sentiment','emosi','emotion'
      ].map(x=>x.toLowerCase()));

      const chips = [];
      for(const [k,v] of Object.entries(row)){
        if(v==null || v==='') continue; const keyLower = String(k).toLowerCase();
        if(exclude.has(keyLower)) continue;
        if([cols.text, cols.time, cols.url, cols.alasan, cols.parent_text].includes(k)) continue;
        if(keyLower===String(cols.user).toLowerCase() || keyLower==='user_screen_name') continue;
        if(keyLower===String(cols.sentiment||'').toLowerCase()) continue;
        if(keyLower===String(cols.emotion||'').toLowerCase()) continue;
        const val = String(v); const short = val.length>64? val.slice(0,61)+'‚Ä¶' : val;
        chips.push(`<span class="chip">${escapeHtml(k)}: <b>${escapeHtml(short)}</b></span>`);
      }

      let extras = '';
      if(parent){
        const shortP = String(parent).length>120? escapeHtml(String(parent).slice(0,117)+'‚Ä¶') : escapeHtml(parent);
        extras += `
          <div class="chips">
            <details class="inline">
              <summary>‚Ü™Ô∏è Balasan ke parent ¬∑ <em>${shortP}</em></summary>
              <div style="margin-top:6px">${decorateText(escapeHtml(parent))}</div>
            </details>
          </div>`;
      }
      if(alasan){
        const shortA = String(alasan).length>120? escapeHtml(String(alasan).slice(0,117)+'‚Ä¶') : escapeHtml(alasan);
        extras += `
          <div class="chips">
            <details class="inline">
              <summary>üìù Intisari ¬∑ <em>${shortA}</em></summary>
              <div style="margin-top:6px">${decorateText(escapeHtml(alasan))}</div>
            </details>
          </div>`;
      }

      const uname = screen ? String(screen).replace(/^@/, '') : '';
      const xUrl = (tid && uname) ? `https://x.com/${encodeURIComponent(uname)}/status/${encodeURIComponent(tid)}` : '';
      const openStat = xUrl ? `<span class="stat"><a href="${xUrl}" target="_blank" rel="noreferrer" title="Buka di X">üåê <b>Buka</b></a></span>` : '';

      return `
      <article class="card">
        <div class="avatar" title="${escapeHtml(user)}">${escapeHtml(initials(user))}</div>
        <div>
          <div class="meta">
            <span class="name">${escapeHtml(user)}</span>
            ${handle? `<span class="handle">${escapeHtml(handle)}</span>`:''}
            ${time? `<span class="time">‚Ä¢ ${escapeHtml(time)}</span>`:''}
            ${sent? `<span class="badge">${emojiForSentiment(sent)} ${escapeHtml(sent)}</span>`:''}
            ${emo? `<span class="badge">${emojiForEmotion(emo)} ${escapeHtml(emo)}</span>`:''}
          </div>
          <div class="text">${decorateText(escapeHtml(txt))}</div>
          ${extras}
          ${chips.length? `<div class="chips">${chips.join('')}</div>`:''}
          <div class="stats">
            ${replies!=null && replies!==''? `<span class="stat">üí¨ <b>${escapeHtml(replies)}</b> Balasan</span>`:''}
            ${retweets!=null && retweets!==''? `<span class="stat">üîÅ <b>${escapeHtml(retweets)}</b> Retweet</span>`:''}
            ${likes!=null && likes!==''? `<span class="stat">‚ù§Ô∏è <b>${escapeHtml(likes)}</b> Suka</span>`:''}
            ${openStat}
            ${url? `<span class="stat">üîó <a href="${escapeAttr(url)}" target="_blank" rel="noreferrer"><b>Link</b></a></span>`:''}
          </div>
        </div>
      </article>`;
    }

    // ===== Events =====
    fileInput.addEventListener('change', async (e)=>{
      const file = e.target.files?.[0]; if(!file) return;
      const text = await file.text();
      const rows = parseCSV(text);
      if(rows.length===0){ alert('File kosong.'); return; }
      HEADERS = rows[0];
      const body = rows.slice(1).filter(r=> r.some(c=> String(c).trim()!==''));
      DATA = body.map(r=> buildRowObj(HEADERS, r));
      FILTERED = DATA.slice();
      populateColumnSelect(HEADERS);
      enableControls();
      renderPage();
    });

    btnSearch.addEventListener('click', applyFilter);
    btnClear.addEventListener('click', ()=>{ queryInput.value=''; FILTERED = DATA.slice(); page=1; renderPage(); });
    queryInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ applyFilter(); } });

    prevBtn.addEventListener('click', ()=>{ if(page>1){ page--; renderPage(); }});
    nextBtn.addEventListener('click', ()=>{ const maxPage=Math.ceil(FILTERED.length/PAGE_SIZE)||1; if(page<maxPage){ page++; renderPage(); }});

    // Advanced Search bindings
    btnAdvanced.addEventListener('click', openAdvanced);
    document.getElementById('btnAddCond').addEventListener('click', ()=> addCondRow());
    document.getElementById('btnApplyAdv').addEventListener('click', applyAdvanced);
    document.getElementById('btnClearAdv').addEventListener('click', clearAdvanced);
    document.getElementById('btnCloseAdv').addEventListener('click', closeAdvanced);
    document.addEventListener('keydown', (e)=>{
      if(e.key==='Escape'){
        if(advBackdrop.getAttribute('aria-hidden')==='false') closeAdvanced();
        if(alasanBackdrop.getAttribute('aria-hidden')==='false') closeAlasan();
      }
    });

    // Alasan export bindings
    btnExportAlasan.addEventListener('click', openAlasan);
    btnCopyAlasan.addEventListener('click', copyAlasan);
    btnDownloadAlasan.addEventListener('click', downloadAlasan);
    btnCloseAlasan.addEventListener('click', closeAlasan);
  </script>
</body>
</html>
